<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/sweetalert2@7.12.15/dist/sweetalert2.min.css'></link>

<style>
    .btn-danger{
       background-color: red;
       border:none;
    }
    .modal {
  display: none;
  position: fixed;
  z-index: 1;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
  background-color: #fefefe;
  margin: 15% auto;
  padding: 20px;
  border: 1px solid #888;
  width: 80%;
}

.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}

.close:hover,
.close:focus {
  color: black;
  text-decoration: none;
  cursor: pointer;
}

</style>

<section class="mt-50 mb-50">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="table-responsive">
                    <table class="table shopping-summery text-center clean">
                        <thead>
                            <tr class="main-heading">
                                
                                <th style="color: goldenrod" scope="col"><strong>Name</strong> </th>
                                <th style="color: goldenrod" scope="col"><strong>Price</strong> </th>
                                <th style="color: goldenrod" scope="col"><strong>Count</strong> </th>
                                <th style="color: goldenrod" scope="col"><strong>Total</strong> </th>
                                <th style="color: goldenrod" scope="col"><strong>Payment</strong> </th>
                                <th style="color: goldenrod" scope="col"><strong>Status</strong> </th>
                                <th style="color: goldenrod" scope="col"><strong>Address</strong> </th>
                                <th style="color: goldenrod" scope="col"><strong>ordered on</strong> </th>
                                <th style="color: goldenrod" scope="col"><strong>Options</strong></th>
                            </tr>
                        </thead>
                        <tbody>
                            <%userOrder.forEach(order=>{%>

                           
                                <%order.products.forEach(item=>{%>
                                   
                                        <tr>
                                
                                            <td class="product-des product-name">
                                                <h5 class="font-xs pt-2"><%= item.productname %>
                                                </h5>
                                            </td>
                                            <td class="price" data-title="Price"><span>₹<%= item.productnetprice%></span></td>
                                           
                                            <td class="text-center" data-title="Quantity"><%= item.quantity%></td>
                                            
                                            <td class="text-center" data-title="Subtotal">
                                                <span>₹<%= item.totalAmount%></span>
                                            </td>
                                            <td class="text-center" data-title="paymentmethod"><%=order.paymentMethod%></td>
                                            <td class="text-center" data-title="status"><%=item.deliveryStatus%></td>
                                            <td> 
                                                
                                                   
                                                
                                                
                                                <p><%= order.deliveryDetails.streetaddress %></p> 
                                                <p><%= order.deliveryDetails.appartment %></p> 
                                                <p><%= order.deliveryDetails.state %>,<%= order.deliveryDetails.town %></p>
                                                <p> <%= order.deliveryDetails.zip %></p> </td>
                                                <td><%= new Date(order.createdAt).toLocaleString('en-US', {
                                                    month: 'short',
                                                    day: 'numeric',
                                                    year: 'numeric',
                                                    hour: 'numeric',
                                                    minute: 'numeric',
                                                    hour12: true
                                                }) %></td>
                                            <%if(item.deliveryStatus !== "Delivered"){%>
                                            <td class="action-col">
                                                <%if(item.deliveryStatus === "Cancelled" || item.deliveryStatus === "Returned" ||item.deliveryStatus === "Return requested"){%>
                                                    <p class="text-danger"><%=item.deliveryStatus%></p>
            
                                                    <%}else{%>
                                                        <button class="btn btn-danger " 

                                                        onclick="cancelOrder('<%=order._id%>','<%=item._id%>','<%=item.productId%>','<%=item.quantity%>','<%=order.paymentStatus%>','<%=item.productnetprice%>','<%=cartTotal.total%>','<%=order.paymentMethod%>','<%=item.deliveryStatus%>')">
                                                        
                                                        Cancel Order
                                                         
                                                        </button>
                                                        <%}%>
                                                </td>
                                            <%}else{%>  
                                                <td class="action-col">
                                                
                                                    <button class="btn btn-primary"onclick="returnOrder('<%=order._id%>','<%=item._id%>','<%=item.productId%>','<%=item.quantity%>','<%=item.productnetprice%>')">Return</button>
                                                  
                                                    </td>
                                            <%}%>  
                                          
                                        </tr>
                                 
                           
                            <% })%> 
                           <%})%>
                        </tbody>
                 </table>
             </div>
        </div>
    </div>
</section> 
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.4/dist/sweetalert2.min.js"></script>
<script>
    function cancelOrder(orderId,itemId,productId,quantity,paymentSatus,productPrice,grandTotal,paymentMethod,deliveryStatus){
        console.log(orderId,"orderid");
        console.log(productId,"product id");
        console.log(quantity,"quantity");
        console.log(paymentSatus,"payment status");
        console.log(productPrice,'product price');
        console.log(grandTotal,"grand Total");
        console.log(paymentMethod,"payment method")
        console.log(deliveryStatus,"delivery status")
       console.log(itemId)

        let refundAmount = ( productPrice*quantity)
        console.log(refundAmount);

        Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#4CAF50',
                confirmButtonText: 'Yes, cancel it!'
              }).then((result)=>{
                if(result.isConfirmed){
                    $.ajax({
                        url:'/cancel-order',
                        type:'PATCH',
                        data:{
                           orderId:orderId,
                           productId:productId,
                            quantity:quantity,
                            paymentSatus:paymentSatus,
                            deliveryStatus:deliveryStatus,
                            refundAmount:refundAmount,
                            paymentMethod:paymentMethod,
                            itemId:itemId
                        },
                        success:((response)=>{
                            if(response.status){
                                Swal.fire({
                                position: 'center',
                                icon: 'success',
                                title: 'Order cancelled successfully',
                                showConfirmButton: false,
                                timer: 1500
                                }).then(()=>{
                                    location.reload()
                                })
                            }
                        }),error:((error)=>{ Swal.fire({
                                position: 'center',
                                icon: 'success',
                                title: 'Order cancelling failed',
                                showConfirmButton: false,
                                timer: 1500
                                })})
                })
            }  })
    }
 
    function returnOrder(orderId,ItemId,productId,quantity,refundAmount){  
       
      Swal.fire({
            title: 'Are you sure?',
            // text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, proceed!'
            }).then(async(result) => {
            if (result.isConfirmed) {
                const { value: text } = await Swal.fire({
                        input: 'textarea',
                        inputLabel: 'Reason to return',
                        inputPlaceholder: 'Type your reason here...',
                        inputAttributes: {
                            'aria-label': 'Type your reason here'
                        },
                        showCancelButton: true
                        })
                      

                        if (text) {
                           
                            $.ajax({
                                url:'/return-order',
                                type:'PATCH',
                                data:{
                                    orderId,
                                    productId,
                                    quantity,
                                    text,
                                    ItemId,
                                    refundAmount
                                },
                                success:((response)=>{
                                    console.log('in response')
                                Swal.fire({
                                    position: 'center',
                                    icon: 'success',
                                    title: 'Return request submitted successfully',
                                    showConfirmButton: false,
                                    timer: 1500
                                    }).then(()=>{
                                        location.reload();
                                    })

                                }),error:((error)=>{
                                    Swal.fire({
                                    position: 'center',
                                    icon: 'success',
                                    title: 'Return request not submitted',
                                    showConfirmButton: false,
                                    timer: 1500
                                    })
                                })

                            })
                }
            }
        })
      }
</script>